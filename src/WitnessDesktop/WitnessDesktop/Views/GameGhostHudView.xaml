<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WitnessDesktop.ViewModels"
             x:Class="WitnessDesktop.Views.GameGhostHudView"
             x:Name="HudRoot"
             x:DataType="vm:MainViewModel">

    <Border BackgroundColor="{StaticResource BgSecondary}"
            Padding="16"
            Stroke="{StaticResource BgCard}"
            StrokeThickness="1">
        <Border.StrokeShape>
            <RoundRectangle CornerRadius="20"/>
        </Border.StrokeShape>
        <Border.Shadow>
            <Shadow Brush="{StaticResource AccentPurple}"
                    Offset="0,0"
                    Radius="20"
                    Opacity="0.3"/>
        </Border.Shadow>

        <Grid RowDefinitions="Auto,Auto,*,Auto,Auto" RowSpacing="12">

            <!-- ========== ROW 0: HEADER (always visible) ========== -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12">

                <!-- Agent Avatar (circular with purple glow) -->
                <Grid Grid.Column="0">
                    <Border BackgroundColor="{StaticResource BgCard}"
                            WidthRequest="48"
                            HeightRequest="48">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="24"/>
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow Brush="{StaticResource AccentPurple}"
                                    Offset="0,0"
                                    Radius="12"
                                    Opacity="0.5"/>
                        </Border.Shadow>
                        <Image Source="{Binding SelectedAgent.IconImage, FallbackValue='default_agent.png'}"
                               WidthRequest="36"
                               HeightRequest="36"
                               Aspect="AspectFill"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
                    </Border>
                    <!-- Green status dot overlay -->
                    <Ellipse Fill="{StaticResource AccentGreen}"
                             WidthRequest="12"
                             HeightRequest="12"
                             HorizontalOptions="End"
                             VerticalOptions="End"
                             Margin="0,0,0,0"
                             IsVisible="{Binding IsConnected}"/>
                </Grid>

                <!-- Agent Name + Role -->
                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                    <Label Text="{Binding SelectedAgent.Name, FallbackValue='No Agent'}"
                           FontFamily="RajdhaniSemiBold"
                           TextColor="{StaticResource TextPrimary}"
                           FontSize="16"/>
                    <HorizontalStackLayout Spacing="4">
                        <Ellipse Fill="{StaticResource AccentGreen}"
                                 WidthRequest="6"
                                 HeightRequest="6"
                                 VerticalOptions="Center"
                                 IsVisible="{Binding IsConnected}"/>
                        <Label Text="{Binding SelectedAgent.Id, FallbackValue='Select an agent'}"
                               FontFamily="RajdhaniRegular"
                               TextColor="{StaticResource TextSecondary}"
                               FontSize="12"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Settings gear (reserved) -->
                <Button Grid.Column="2"
                        Text="&#x2699;"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        CornerRadius="8"
                        BackgroundColor="{StaticResource BgCard}"
                        TextColor="{StaticResource TextMuted}"
                        FontSize="16"/>

                <!-- Expand/collapse chevron -->
                <Button Grid.Column="3"
                        Text="{Binding ChevronText, Source={x:Reference HudRoot}}"
                        WidthRequest="36"
                        HeightRequest="36"
                        Padding="0"
                        CornerRadius="8"
                        BackgroundColor="{StaticResource BgCard}"
                        TextColor="{StaticResource TextSecondary}"
                        FontSize="14"
                        Clicked="OnToggleExpand"/>
            </Grid>

            <!-- ========== ROW 1: TAGS (visible when expanded AND has content) ========== -->
            <HorizontalStackLayout Grid.Row="1"
                                   Spacing="8"
                                   IsVisible="False"
                                   x:Name="TagsRow">
                <Border BackgroundColor="{StaticResource AccentPurple}"
                        Padding="10,4"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Label Text="{Binding SlidingPanelContent.Title, FallbackValue='AI INSIGHT'}"
                           FontFamily="OrbitronBold"
                           TextColor="White"
                           FontSize="9"
                           CharacterSpacing="1"/>
                </Border>
            </HorizontalStackLayout>

            <!-- ========== ROW 2: CONTENT AREA (visible when expanded) ========== -->
            <Border Grid.Row="2"
                    BackgroundColor="{StaticResource BgCard}"
                    Padding="16,12"
                    IsVisible="False"
                    x:Name="ContentArea"
                    MinimumHeightRequest="80">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>

                <Grid>
                    <!-- Placeholder: no content -->
                    <VerticalStackLayout VerticalOptions="Center"
                                        HorizontalOptions="Center"
                                        IsVisible="{Binding HasPanelContent, Converter={StaticResource InvertedBoolConverter}}">
                        <Label Text="&#x1F3AE;"
                               FontSize="28"
                               HorizontalOptions="Center"
                               Opacity="0.4"/>
                        <Label Text="Watching your game..."
                               FontFamily="RajdhaniRegular"
                               TextColor="{StaticResource TextSecondary}"
                               FontSize="14"
                               HorizontalOptions="Center"
                               Margin="0,6,0,0"
                               Opacity="0.6"/>
                    </VerticalStackLayout>

                    <!-- AI Content -->
                    <ScrollView IsVisible="{Binding HasPanelContent}"
                                VerticalOptions="Fill">
                        <VerticalStackLayout Spacing="10" Padding="4,0">
                            <!-- Body text -->
                            <Label Text="{Binding SlidingPanelContent.Text}"
                                   FontFamily="RajdhaniRegular"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="18"
                                   LineHeight="1.3"/>

                            <!-- Optional image -->
                            <Image Source="{Binding SlidingPanelContent.ImageSource}"
                                   IsVisible="{Binding SlidingPanelContent.ImageSource, Converter={StaticResource IsNotNullConverter}}"
                                   Aspect="AspectFit"
                                   MaximumHeightRequest="120"
                                   MaximumWidthRequest="350"
                                   HorizontalOptions="Start"
                                   Margin="0,4,0,0">
                                <Image.Clip>
                                    <RoundRectangleGeometry CornerRadius="8" Rect="0,0,350,120"/>
                                </Image.Clip>
                            </Image>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Tap to dismiss -->
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding DismissSlidingPanelCommand}"/>
                    </Grid.GestureRecognizers>
                </Grid>
            </Border>

            <!-- ========== ROW 3: STATUS BAR (always visible) ========== -->
            <Grid Grid.Row="3" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">

                <!-- LIVE indicator -->
                <HorizontalStackLayout Grid.Column="0" Spacing="6" VerticalOptions="Center"
                                       IsVisible="{Binding IsConnected}">
                    <Ellipse Fill="{StaticResource AccentRed}"
                             WidthRequest="8"
                             HeightRequest="8"
                             VerticalOptions="Center"/>
                    <Label Text="LIVE"
                           FontFamily="RajdhaniSemiBold"
                           TextColor="{StaticResource AccentRed}"
                           FontSize="12"/>
                </HorizontalStackLayout>

                <!-- Audio Visualizer Bars (5 purple bars) -->
                <HorizontalStackLayout Grid.Column="1"
                                       HorizontalOptions="Center"
                                       Spacing="3"
                                       VerticalOptions="Center">
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=0}" Color="{StaticResource AccentPurple}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=1}" Color="{StaticResource AccentPurple}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=2}" Color="{StaticResource AccentPurple}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=3}" Color="{StaticResource AccentPurple}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=4}" Color="{StaticResource AccentPurple}" CornerRadius="2" VerticalOptions="End"/>
                </HorizontalStackLayout>

                <!-- Mic icon -->
                <Label Grid.Column="2"
                       Text="&#x1F3A4;"
                       FontSize="14"
                       TextColor="{StaticResource TextMuted}"
                       VerticalOptions="Center"/>
            </Grid>

            <!-- ========== ROW 4: DISCONNECT BUTTON (visible when connected) ========== -->
            <Button Grid.Row="4"
                    Text="&#x23FB;  Disconnect"
                    BackgroundColor="{StaticResource AccentPurple}"
                    TextColor="White"
                    FontFamily="RajdhaniSemiBold"
                    FontSize="14"
                    Padding="16,10"
                    CornerRadius="12"
                    HorizontalOptions="Fill"
                    Command="{Binding ToggleConnectionCommand}"
                    IsVisible="{Binding IsConnected}"/>

        </Grid>
    </Border>
</ContentView>
