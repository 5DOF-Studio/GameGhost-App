<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WitnessDesktop.ViewModels"
             x:Class="WitnessDesktop.Views.MinimalViewPage"
             x:DataType="vm:MainViewModel"
             BackgroundColor="{StaticResource BgPrimary}"
             Title="Game Ghost - Connected">

    <Border BackgroundColor="{StaticResource BgSecondary}"
            Margin="12"
            Padding="16">
        <Border.StrokeShape>
            <RoundRectangle CornerRadius="16"/>
        </Border.StrokeShape>
        
        <Grid RowDefinitions="Auto,*,Auto" RowSpacing="12">
            
            <!-- ========== TOP ROW: Header ========== -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="16">
                
                <!-- Agent Profile Icon -->
                <Border Grid.Column="0"
                        BackgroundColor="{StaticResource BgCard}"
                        WidthRequest="52"
                        HeightRequest="52">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="{StaticResource AccentPurple}"
                                Offset="0,0"
                                Radius="16"
                                Opacity="0.4"/>
                    </Border.Shadow>
                    <Image Source="{Binding SelectedAgent.IconImage, FallbackValue='default_agent.png'}"
                           WidthRequest="36"
                           HeightRequest="36"
                           Aspect="AspectFill"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>
                
                <!-- Agent & Game Info -->
                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                    <Label Text="{Binding SelectedAgent.Name}"
                           FontFamily="RajdhaniSemiBold"
                           TextColor="{StaticResource TextPrimary}"
                           FontSize="18"/>
                    <HorizontalStackLayout Spacing="6">
                        <Label Text="ðŸ–¥ï¸" FontSize="11" VerticalOptions="Center"/>
                        <Label Text="{Binding CurrentTarget.ProcessName}"
                               FontFamily="RajdhaniRegular"
                               TextColor="{StaticResource TextSecondary}"
                               FontSize="12"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                
                <!-- Audio Levels -->
                <VerticalStackLayout Grid.Column="2" VerticalOptions="Center" Spacing="2">
                    <HorizontalStackLayout Spacing="4">
                        <Label Text="ðŸŽ¤" FontSize="10" VerticalOptions="Center"/>
                        <Label Text="AUDIO"
                               FontFamily="OrbitronBold"
                               TextColor="{StaticResource AccentCyan}"
                               FontSize="8"
                               CharacterSpacing="1"
                               VerticalOptions="Center"/>
                    </HorizontalStackLayout>
                    <HorizontalStackLayout Spacing="10">
                        <Label FontFamily="RajdhaniRegular" TextColor="{StaticResource TextSecondary}" FontSize="10">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="IN: "/>
                                    <Span Text="{Binding InputVolume, StringFormat='{0:P0}'}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        <Label FontFamily="RajdhaniRegular" TextColor="{StaticResource TextSecondary}" FontSize="10">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="OUT: "/>
                                    <Span Text="{Binding OutputVolume, StringFormat='{0:P0}'}"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                
                <!-- Expand Button (use Button to avoid gesture quirks on MacCatalyst) -->
                <Button Grid.Column="3"
                        Text="â¤¢"
                        WidthRequest="40"
                        HeightRequest="40"
                        Padding="0"
                        CornerRadius="8"
                        BackgroundColor="{StaticResource BgCard}"
                        TextColor="{StaticResource TextSecondary}"
                        FontSize="16"
                        Command="{Binding ExpandToMainViewCommand}"/>
            </Grid>
            
            <!-- ========== MIDDLE: Message Display Area ========== -->
            <Border Grid.Row="1" 
                    BackgroundColor="{StaticResource BgCard}"
                    Padding="24,16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>
                
                <Grid>
                    <!-- Default state: Ready message -->
                    <VerticalStackLayout VerticalOptions="Center"
                                        HorizontalOptions="Center"
                                        IsVisible="{Binding HasPanelContent, Converter={StaticResource InvertedBoolConverter}}">
                        <Label Text="ðŸŽ®"
                               FontSize="32"
                               HorizontalOptions="Center"
                               Opacity="0.4"/>
                        <Label Text="Watching your game..."
                               FontFamily="RajdhaniRegular"
                               TextColor="{StaticResource TextSecondary}"
                               FontSize="16"
                               HorizontalOptions="Center"
                               Margin="0,8,0,0"
                               Opacity="0.6"/>
                    </VerticalStackLayout>
                    
                    <!-- AI Message Display -->
                    <ScrollView IsVisible="{Binding HasPanelContent}"
                                VerticalOptions="Center">
                        <VerticalStackLayout Spacing="12"
                                            HorizontalOptions="Center"
                                            Padding="20,0">
                            <!-- Message Header -->
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                <Label Text="âœ¨"
                                       FontSize="14"
                                       VerticalOptions="Center"/>
                                <Label Text="{Binding SlidingPanelContent.Title, FallbackValue='AI INSIGHT'}"
                                       FontFamily="OrbitronBold"
                                       TextColor="{StaticResource AccentCyan}"
                                       FontSize="11"
                                       CharacterSpacing="2"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                            
                            <!-- Message Text (Large, centered) -->
                            <Label Text="{Binding SlidingPanelContent.Text}"
                                   FontFamily="RajdhaniRegular"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="20"
                                   LineHeight="1.3"
                                   HorizontalTextAlignment="Center"
                                   HorizontalOptions="Center"
                                   MaximumWidthRequest="800"/>
                            
                            <!-- Optional Image -->
                            <Image Source="{Binding SlidingPanelContent.ImageSource}"
                                   Aspect="AspectFit"
                                   MaximumHeightRequest="120"
                                   MaximumWidthRequest="400"
                                   HorizontalOptions="Center"
                                   Margin="0,8,0,0"/>
                            
                            <!-- Dismiss hint -->
                            <Label Text="tap to dismiss"
                                   FontFamily="RajdhaniRegular"
                                   TextColor="{StaticResource TextSecondary}"
                                   FontSize="10"
                                   HorizontalOptions="Center"
                                   Opacity="0.5"
                                   Margin="0,8,0,0"/>
                        </VerticalStackLayout>
                    </ScrollView>
                    
                    <!-- Tap to dismiss gesture -->
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding DismissSlidingPanelCommand}"/>
                    </Grid.GestureRecognizers>
                </Grid>
            </Border>
            
            <!-- ========== BOTTOM ROW: LIVE | Audio Bars | Disconnect ========== -->
            <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                
                <!-- LIVE Indicator -->
                <HorizontalStackLayout Grid.Column="0" Spacing="6" VerticalOptions="Center" IsVisible="{Binding IsConnected}">
                    <Ellipse Fill="{StaticResource AccentGreen}"
                             WidthRequest="8"
                             HeightRequest="8"
                             VerticalOptions="Center"/>
                    <Label Text="LIVE"
                           FontFamily="RajdhaniSemiBold"
                           TextColor="{StaticResource AccentGreen}"
                           FontSize="12"/>
                </HorizontalStackLayout>
                
                <!-- Audio Visualizer Bars (original horizontal style) -->
                <HorizontalStackLayout Grid.Column="1" 
                                       HorizontalOptions="Center" 
                                       Spacing="2" 
                                       VerticalOptions="Center">
                    <!-- Bind to ActivityVolume so bars respond to either mic (IN) or playback (OUT). -->
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=0}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=1}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=2}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=3}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=4}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=5}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=6}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=7}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=8}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=9}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=10}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                    <BoxView WidthRequest="4" HeightRequest="{Binding ActivityVolume, Converter={StaticResource AudioBarHeightConverter}, ConverterParameter=11}" Color="{StaticResource AccentCyan}" CornerRadius="2" VerticalOptions="End"/>
                </HorizontalStackLayout>
                
                <!-- Disconnect Button (smaller) -->
                <Button Grid.Column="2"
                        Text="â» DISCONNECT"
                        BackgroundColor="{StaticResource AccentRed}"
                        TextColor="White"
                        FontFamily="RajdhaniSemiBold"
                        FontSize="11"
                        Padding="14,8"
                        CornerRadius="6"
                        Command="{Binding ToggleConnectionCommand}"/>
            </Grid>
            
        </Grid>
    </Border>
</ContentPage>
